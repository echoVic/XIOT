<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>个人资料</title>
		<link rel="stylesheet" type="text/css" href="css/perinfo.css" />
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/bootstrap.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>

		<div class="g-doc">
			<div class="g-hd">
				<div class="g-hdc">
					<div class="m-head">
						<div class="logo">
							<a href="https://app.netease.im/index" class="link"></a>
						</div>
					</div>
				</div>
			</div>
			<div class="g-bd">
				<div class="g-bdc">
					<div id="perinfo">
						<div class="wrap-content">
							<div class="content-title">
								<span>个人资料</span>
								
								<span id="edit-btn" class="account-icon" style="background-image: url(images/edit.png);"></span>
							</div>
							<div class="content-main">
								<div class="con-wrap">
									<form class="perinfo-form" name="infoform">

										<div class="reg-item">
											<div class="input-label">
												<label>用户名:</label>
											</div>
											<input disabled="disabled" type="text" name="user" class="outline-input text-user">

											<li class="tip-info user-info"></li>
										</div>

										<div class="reg-item">
											<div class="input-label">
												<label>真实姓名:</label>
											</div>
											<input disabled="disabled" type="text" name="realname" class="outline-input text-realname" placeholder="请输入真实姓名" value="无">

											<li class="tip-info realname-info"></li>
										</div>
										
										<div class="reg-item">
											<div class="input-label">
												<label>性别:</label>
											</div>											
											<input disabled="disabled" type="text" name="gender" class="outline-input text-gender" value="男">
											<div class="edit-info hidden">
												<div class="roundedOne">
											      	<input type="radio" value="男" id="roundedOne" name="sex" checked />											      	
											      	<label for="roundedOne"></label>
											    </div>
											    <span class="sex-option">男</span>
											    <div class="roundedOne">
											      	<input type="radio" value="女" id="roundedTwo" name="sex"/>
											      	<label for="roundedTwo"></label>
											    </div>
											    <span class="sex-option">女</span>
											</div>
											    
											<li class="tip-info gender-info"></li>
										</div>
										
										<div class="reg-item">
											<div class="input-label">
												<label>生日:</label>
											</div>
											<input disabled="disabled" type="text" name="birth" class="outline-input text-birth" value="无">
											<div class="edit-info hidden">
												<select class="birth-sel" id="sel_year"></select> 年
												<select class="birth-sel" id="sel_month"></select> 月
												<select class="birth-sel" id="sel_day"></select> 日
												<script class="resources library" src="js/birthday.js" type="text/javascript"></script>
	
												<!--<script type="text/javascript">
													$(function () {
														$.ms_DatePicker({
											            	YearSelector: ".sel_year",
											            	MonthSelector: ".sel_month",
											            	DaySelector: ".sel_day"
											    		});
														$.ms_DatePicker();
													});
												</script>-->
											</div>											

											<li class="tip-info birth-info"></li>
										</div>

										<div class="reg-item">
											<div class="input-label">
												<label>所在地:</label>
											</div>
											<input disabled="disabled" type="text" name="location" class="outline-input text-location" value="无">
											<div class="edit-info hidden">
												<select class="location-sel s_province" id="s_province" name="s_province"></select>
												<select class="location-sel s_city" id="s_city" name="s_city"></select>
												<select class="location-sel s_county" id="s_county" name="s_county"></select>
												<script class="resources library" src="js/area.js" type="text/javascript"></script>
	
												<!--<script type="text/javascript">
													_init_area();
												</script>-->
											</div>											

											<li class="tip-info location-info"></li>
										</div>
										
										<div class="reg-item">
											<div class="input-label">
												<label>工作单位或学校:</label>
											</div>
											<input disabled="disabled" type="text" name="unit" class="outline-input text-unit" value="无" placeholder="请输入工作单位或学校">

											<li class="tip-info unit-info"></li>
										</div>

										<div class="reg-item">
											<div class="input-label">
												<label>邮箱:</label>
											</div>
											<input disabled="disabled" autocomplete="off" id="email" type="text" name="email" class="outline-input text-email" placeholder="请输入邮箱" value="无">

											<li class="tip-info email-info"></li>
										</div>
										
										<div class="reg-item">
											<div class="input-label">
												<label>手机号:</label>
											</div>
											<input disabled="disabled" autocomplete="off" type="text" name="mobile" class="outline-input text-mobile" placeholder="请输入11位手机号" value="无">

											<li class="tip-info mobile-info"></li>
										</div>
										
										<div class="reg-item">
											<div class="input-label">
												<label>QQ:</label>
											</div>
											<input disabled="disabled" autocomplete="off" type="text" name="qqnum" class="outline-input text-qqnum" placeholder="请输入QQ号" value="无">

											<li class="tip-info qqnum-info"></li>
										</div>
										
										<div class="reg-item">
											<div class="input-label">
												<label>个人简介:</label>
											</div>
											<textarea disabled="disabled" name="summary" class="outline-input text-summary" autocomplete="off">无
											</textarea>

											<li class="tip-info summary-info"></li>
										</div>

										<div class="reg-item">
											<input id="perinfo-btn" type="button" class="reg-btn check-account hidden" value="保存">
										</div>

									</form>
								</div>
							</div>

						</div>
					</div>

				</div>
			</div>
		</div>
		<script type="text/javascript">
			$(function() {
				function GetQueryString(name) {
			   		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)","i");
			   		var r = window.location.search.substr(1).match(reg);
			   		if (r!=null) return (r[2]); return null;
				}
				var userName = GetQueryString("userName");
				$('.text-user').val(userName);
				
				$.ajax({
					type:"get",
					url:"user/getInfo",
					async:true,
					dataType:"json",
					success:function(data){
						var result = data.result;
						var result = eval("("+result+")")
						if(data.status = 'SUCCESS') {

							var userName = result.userName;
							var email = result.email;
							var telphone = result.telphone;
							var trueName = result.trueName;
							var sex = result.sex;
							var job = result.job;
							var birthday = result.birthday;
							var address = result.address;
							var qq = result.qq;
							var intro = result.intro;
							
//							if (!(user === uerName)) {
//								window.location.href = "login.html";
//							}
							
							if(trueName) {
								$(".text-realname").val(trueName);
							} else {
								$(".text-realname").val('无');
							}
							
							if(sex) {
								$(".text-gender").val(sex);
							} else {
								$(".text-gender").val('无');
							}
							
							if(email) {
								$(".text-email").val(email);
							} else {
								$(".text-email").val('无');
							}
							
							if(address) {
								$(".text-location").val(address);
							} else {
								$(".text-location").val('无');
							}
							
							if(birthday) {
								$(".text-birth").val(birthday);
							} else {
								$(".text-birth").val('无');
							}
							
							if(job) {
								$(".text-unit").val(job);
							} else {
								$(".text-unit").val('无');
							}
							
							if(telphone) {
								$(".text-mobile").val(telphone);
							} else {
								$(".text-mobile").val('无');
							}
							
							if(qq) {
								$(".text-qqnum").val(qq);
							} else {
								$(".text-qqnum").val('无');
							}
							
							if(intro) {
								$(".text-summary").val(intro);
							} else {
								$(".text-summary").val('无');
							}
						}							
					}
				});
				
				// 开启个人资料编辑
				$("#edit-btn").click(function() {

					var fr_edit = document.infoform;
					var edit_realname = fr_edit.realname.value;
					var edit_gender = fr_edit.gender.value;
					
					var edit_birth = fr_edit.birth.value;
					var birth_array = edit_birth.toString().split("-");
					var edit_birth_year = parseInt(birth_array[0]);
					var edit_birth_month = parseInt(birth_array[1]);
					var edit_birth_day = parseInt(birth_array[2]);
					
					if (edit_birth == '无') {
						$.ms_DatePicker();
					} else {
						$("#sel_year").attr("rel",edit_birth_year);
						$("#sel_month").attr("rel",edit_birth_month);
						$("#sel_day").attr("rel",edit_birth_day);
						$.ms_DatePicker();
					}
					
					var edit_location = fr_edit.location.value;
					var location_array = edit_location.toString().split(" ")
					var edit_lo_province = location_array[0];
					var edit_lo_city = location_array[1];
					var edit_lo_county = location_array[2];					
					if (edit_location == '无') {
						_init_area();
						edit_location = '省份 地级市 区、县';
					} else {
						_init_area();
						$("#s_province option[value='"+edit_lo_province+"']").attr("selected","selected");
						change(1);
						console.log(document.getElementById('s_province').selectedIndex)
						$("#s_city option[value='"+edit_lo_city+"']").attr("selected","selected");
						change(2)
						$("#s_county option[value='"+edit_lo_county+"']").attr("selected","selected");
					}
					
					console.log(edit_birth_day,edit_birth_month,edit_birth_year);
					console.log(edit_lo_city,edit_lo_county,edit_lo_province);

					var edit_unit = fr_edit.unit.value;
					var edit_mobile = fr_edit.mobile.value;
					var edit_qqnum = fr_edit.qqnum.value;
					var edit_summary = fr_edit.summary.value;
					
					$(".text-realname,.text-unit,.text-mobile,.text-qqnum,.text-summary").removeAttr("disabled");
					
					if (edit_realname == '无') {
						$('.text-realname').val('');
					} else {
						$('.text-realname').val(edit_realname);
					}
					
					$('input:radio:checked').val(edit_gender);
					
					if (edit_unit == '无') {
						$('.text-unit').val('');
					} else {
						$('.text-unit').val(edit_unit);
					}
					
					if (edit_mobile == '无') {
						$('.text-mobile').val('');
					} else {
						$('.text-mobile').val(edit_mobile);
					}
					
					if (edit_qqnum == '无') {
						$('.text-qqnum').val('');
					} else {
						$('.text-qqnum').val(edit_qqnum);
					}
					
					if (edit_summary == '无') {
						$('.text-summary').val('');
					} else {
						$('.text-summary').val(edit_summary);
					}

					$(".text-gender,.text-location,.text-birth").addClass("hidden");
					$(".edit-info,.check-account").removeClass("hidden");
				})
				// 保存并提交
				$("#perinfo-btn").click(function() {
					var fr = document.infoform;
					var user = fr.user.value;
					var realname = fr.realname.value;
					var gender = $('input:radio:checked').val();
					var birth_year = $("#sel_year option:selected").val();
					var birth_month = $("#sel_month option:selected").val();
					var birth_day = $("#sel_day option:selected").val();
					if (birth_month < 10) {
						birth_month = '0' + birth_month;
					}
					if (birth_day < 10) {
						birth_day = '0' + birth_day;
					}
					var birth = birth_year + '-' + birth_month + '-' + birth_day;
					var lo_province = $("#s_province option:selected").val();
					var lo_city = $("#s_city option:selected").val();
					var lo_county = $("#s_county option:selected").val();
					var location = lo_province + ' ' + lo_city + ' ' + lo_county;
//					console.log(location,birth);
					var unit = fr.unit.value;
					var email = fr.email.value;
					var mobile = fr.mobile.value;
					var qqnum = fr.qqnum.value;
					var summary = fr.summary.value;
					
					var birth_array = birth.toString().split("-");
					var edit_birth_year = parseInt(birth_array[0]);
					var edit_birth_month = parseInt(birth_array[1]);
					var edit_birth_day = parseInt(birth_array[2]);
					//console.log(edit_birth_day,edit_birth_month,edit_birth_year);
//					if(!(email.match(/^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/))) {
//						$(".email-info").html("请输入正确的邮箱格式！");
//						fr.email.focus();
//						return false;
//					} else {
//						$(".email-info").html("");
//					}
									
					if(realname == '') {
						$(".text-realname").val('无');
					} else {
						$(".text-realname").val(realname);
					}
					
					$(".text-gender").val(gender);
					
					if(lo_province == "省份") {
						$(".text-location").val('无');
					} else {
						$(".text-location").val(location);
					}
					
					if(birth_year == 0) {
						$(".text-birth").val('无');
					} else {
						$(".text-birth").val(birth);
					}
					
					if(unit == '') {
						$(".text-unit").val('无');
					} else {
						$(".text-unit").val(unit);
					}
					
					if(mobile == '') {
						$(".text-mobile").val('无');
					} else {
						if(!(/^1[34578]\d{9}$/.test(mobile))) {
							$(".mobile-info").html("请输入正确的手机号！");
							fr.mobile.focus();
							return false;
						} else {
							$(".text-mobile").val(mobile);
							$(".mobile-info").html("");
						}
					}
					
					if(qqnum == '') {
						$(".text-qqnum").val('无');
					} else {
						$(".text-qqnum").val(qqnum);
					}
					
					if(summary == '') {
						$(".text-summary").val('无');
					} else {
						$(".text-summary").val(summary);
					}
					
					$(".text-realname,.text-gender,.text-location,.text-birth,.text-unit,.text-mobile,.text-qqnum,.text-summary").attr("disabled",true);
					$(".text-gender,.text-location,.text-birth").removeClass("hidden");
					$(".edit-info,.check-account").addClass("hidden");
					
					var updateUser = {
						userName: user,
						trueName: realname,
						sex: gender,
						birthday: birth,
						address: location,
						job: unit,
						qq: qqnum,
						intro: summary,
						telphone: mobile,
						email: email
					}
					$.ajax({
						type:"post",
						url:"user/updateUserInfo",
						async:true,
						data:updateUser,
						dataType:'json'
					});
				})
			})
		</script>
	</body>

</html>